{% extends 'mycpBundle:layout:backend.html.twig' %}
{% block title %}Administración{% endblock %}
{% block another_in_head %}
    {% stylesheets
    '@mycpBundle/Resources/public/css/datepicker.css'
    filter='?uglifycss'
    %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}
{% block top_body %}
<ul class="breadcrumb">
    <li><a href="{{path('mycp_backend_front')}}">Administración</a> <span class="divider">/</span></li>
    <li class="active">Ranking</li>
</ul>
{% endblock %}
{% block content %}
<h2>Ranking</h2>
<hr/>
<br/>

<div class="tab-content" id="myTabContent">
<div id="accommodations" class="tab-pane fade active in">
{% for message in app.session.flashbag.get('message_error_local') %}
<div class="alert alert-error">{{ message }}</div>
{% endfor %}
<form onkeypress="javascript:submit_filters(event);" id="filter" method="post" action="{{path('mycp_list_ranking')}}">
    <div class="well well-small">
        {#<div class="row-fluid">#}
            {#<div class="span3">#}
                {#<label>Propiedad:</label><input id="filter_code" value="{{filter_code}}" class="input-block-level" name="filter_code" type="text"/>#}
            {#</div>#}
            {#<div class="span3">#}
                {#<label>Nombre:</label>#}
                {#<input name="filter_name" value="{{filter_name}}" id="filter_name" autocomplete="off" type="text" class="input-block-level" style="margin: 0 auto;" data-provide="typeahead" data-items="5" data-source='{{ render(controller('mycpBundle:BackendOwnership:get_ownerships_names')) }}'>#}
            {#</div>#}
            {#<div class="span3">#}
                {#<label>Estado:</label>#}
                {#<select id="filter_active" class="input-block-level" name="filter_active">#}
                    {#{{ render(controller('mycpBundle:BackendOwnership:get_status', {'post': filter_active})) }}#}
                    {#</select>#}
                {#</div>#}
                {#<div class="span3">#}
                    {#<label>Fotos:</label>#}
                    {#<select class="input-block-level" name="filter_photos" id="filter_photos">#}
                        {#<option></option>#}
                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_WITH_NO_PHOTOS')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_WITH_NO_PHOTOS')%}selected="TRUE"{%endif%}>Sin fotos</option>#}
                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_PHOTOS_LESS_5')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_PHOTOS_LESS_5')%}selected="TRUE"{%endif%}>Con menos de 5 fotos</option>#}
                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_WITH_NO_OWNER_PHOTO')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_WITH_NO_OWNER_PHOTO')%}selected="TRUE"{%endif%}>Sin foto del propietario</option>#}
                    {#</select>#}
                    {#</div>#}
                {#</div>#}
                {#<div class="row-fluid">#}
                    {#<div class="span3">#}
                        {#<label>Provincia:</label>#}
                        {#<select class="input-block-level" name="filter_province" id="filter_province">#}
                {#{{ render(controller('mycpBundle:Public:get_provinces', {'post': {'ownership_address_province':filter_province}})) }}#}
                            {#</select>#}
                        {#</div>#}
                        {#<div class="span3">#}
                            {#<label>Municipio:</label>#}
                            {#<select class="input-block-level" name="filter_municipality" id="filter_municipality">#}
                                {#{%if filter_province != "" and filter_province != "null" and filter_province != null%}#}
                                {#{{ render(controller('mycpBundle:Public:get_mun', {'post': {'ownership_address_municipality':filter_municipality, 'ownership_address_province': filter_province}})) }}#}
                                {#{%else%}#}
                                {#{{ render(controller('mycpBundle:Public:get_mun', {'post': {'ownership_address_municipality':filter_municipality}})) }}#}
                                {#{%endif%}#}
                                {#</select>#}
                            {#</div>#}
                            {#<div class="span3">#}
                                {#<label>Destino:</label>#}
                                {#<select class="input-block-level" name="filter_destination" id="filter_destination">#}
                {#{{ render(controller('mycpBundle:Public:getDestinations', {'post': {'ownership_destination':filter_destination}})) }}#}
                                    {#</select>#}
                                {#</div>#}
                                {#<div class="span3">#}
                                    {#<label>Información:</label>#}
                                    {#<select class="input-block-level" name="filter_full_info" id="filter_full_info">#}
                                        {#<option></option>#}
                                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_GENERAL')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_GENERAL')%}selected="TRUE"{%endif%}>Información incompleta</option>#}
                                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_ROOMS')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_ROOMS')%}selected="TRUE"{%endif%}>Habitaciones incompletas</option>#}
                                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_INACTIVE_ROOMS')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_INACTIVE_ROOMS')%}selected="TRUE"{%endif%}>Con habitaciones desactivadas</option>#}
                                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_NO_PHONE_OR_MOBILE')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_NO_PHONE_OR_MOBILE')%}selected="TRUE"{%endif%}>Sin teléfono o móvil</option>#}
                                        {#<option value="{{constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_NO_EMAIL')}}" {%if filter_other == constant('\\MyCp\\mycpBundle\\Helpers\\FilterHelper::ACCOMMODATION_INFO_NO_EMAIL')%}selected="TRUE"{%endif%}>Sin correo</option>#}
                                    {#</select>#}
                                    {#</div>#}

                                {#</div>#}
        <div class="row-fluid" style="margin-top: 10px">
            <div class="span9">&nbsp;</div>
            <div class="span1">
                <a rel="tooltip" title="Descargar listado" href="#" class="tooltip_msg btn btn-block btn-warning"><i class="icon-download-alt icon-white"></i></a>
            </div>
            <div class="span1">
                <a rel="tooltip" title="Filtrar listado" href="javascript:action_submit();" class="tooltip_msg btn btn-block btn-success"><i class="icon-filter icon-white"></i></a>
            </div>
            <div class="span1">
                <a rel="tooltip" title="Resetear filtrado" href="{{ path('mycp_list_ranking') }}" class="tooltip_msg btn btn-block btn-danger"><i class="icon-remove icon-white"></i></a>
            </div>

        </div>
                            </div>
                        </form>
    {% if list %}
        <table class="table table-striped table-hover">
             <thead>
                 <tr>
                     <th>Lugar General</th>
                     <th>Lugar Destino</th>
                     <th>Alojamiento</th>
                     <th>Destino</th>
                     <th>Registrada</th>
                     <th>Modalidad</th>
                     <th>Puntos</th>
                     <th>Categoría</th>
                 </tr>
              </thead>
             <tbody>
    {% for item in list %}
            <tr>
                <td>{{ item.place }}</td>
                <td>{{ item.destinationPlace }}</td>
                <td><a target="_blank" href="{{ path("mycp_edit_ownership", {"id_ownership": item.accommodation.ownId}) }}">{{ item.accommodation.ownMcpCode }} - {{ item.accommodation.ownName }}</a></td>
                <td>{{ (item.accommodation.ownDestination != null) ? item.accommodation.ownDestination.desName : " - " }}</td>
                <td>{{ item.accommodation.ownCreationDate | date("d/m/Y") }}</td>
                <td>{{ (item.rr == 5) ? "RR" : ((item.ri == 5) ? "RI": "-") }}</td>
                <td>{{ item.ranking }}</td>
                <td>{{ (item.category != null) ? item.category.translations[0].nomLangDescription : " - " }}</td>
            </tr>
    {% endfor %}
        </tbody>
     </table>
    {% else %}
         <p> <div class="alert alert-block">No hay información de ranking disponible.</div></p>
    {% endif %}
</div>
{% endblock %}
{% block javascripts %}
    {% javascripts
    '@mycpBundle/Resources/public/js/bootstrap-datepicker.js'
    '@mycpBundle/Resources/public/js/bootstrap-datepicker.es.js'
    '@mycpBundle/Resources/public/js/common_list.js'
    '@mycpBundle/Resources/public/js/bootstrap-typeahead.js'
    filter='?uglifyjs2'
    %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script type="text/javascript">
        url = "{{ path('mycp_get_mun_by_prov', { 'country_code': '-1' }) }}";
        url = url.replace('/-1', '');
        $('.datepicker').datepicker({
            format: 'dd-mm-yyyy',
            todayBtn: 'linked',
            autoclose: true,
            language: 'es'
        });
        $('#filter_province').change(function() {
            code = $('#filter_province').val();
            if (code != '')
            {
                $('#filter_municipality').html('<option value="">Cargando...</option>');


                $.ajax({
                    type: "POST",
                    url: url + '/' + code,
                    success: function(msg) {

                        $('#filter_municipality').html(msg);
                    }
                });
            }
        });

        function submit_filters(ev)
        {
            if (ev.keyCode == 13)
            {
                action_submit();
            }
        }
        filter_code = $('#filter_code').val();
        function action_submit()
        {            filter_code = $('#filter_code').val();
            if (filter_code == '')
                filter_code = 'null';
            filter_province = $('#filter_province').val();
            if (filter_province == '')
                filter_province = 'null';
            filter_municipality = $('#filter_municipality').val();
            if (filter_municipality == '')
                filter_municipality = 'null';
            filter_destination = $('#filter_destination').val();
            if (filter_destination == '')
                filter_destination = 'null';
            filter_type = $('#filter_type').val();
            if (filter_type == '')
                filter_type = 'null';
            filter_category = $('#filter_category').val();
            if (filter_category == '')
                filter_category = 'null';

            filter_name = $('#filter_name').val();
            if (filter_name == '')
                filter_name = 'null';
            filter_saler = $('#filter_saler').val();
            if (filter_saler == '')
                filter_saler = 'null';
            filter_visit_date = $('#filter_visit_date').val();
            //filter_visit_date = filter_visit_date.replace()('/','-');
            if (filter_visit_date == '')
                filter_visit_date = 'null';
            filter_active = $('#filter_active').val();
            if (filter_active == '')
                filter_active = 'null';
            filter_other = $('#filter_other').val();
            if (filter_other == '')
                filter_other = 'null';
            filter_commission = $('#filter_commission').val();
            if (filter_commission == '')
                filter_commission = 'null';

            url_submit = $('#filter').attr('action');
            url_submit = url_submit + '/' + filter_code + '/' + filter_active + '/' + filter_category + '/' + filter_province + '/' + filter_municipality + '/' + filter_destination + '/' + filter_type + '/' + filter_name + '/' + filter_saler + '/' + filter_visit_date + '/' + filter_other + '/' + filter_commission;
            $('#filter').attr('action', url_submit);
            $('#filter').submit();
        }
    </script>
{% endblock %}