{% extends 'mycpBundle:layout:backend.html.twig' %}
{% block title %}Administración{% endblock %}
{% block top_body %}
<ul class="breadcrumb">
    <li><a href="{{path('mycp_backend_front')}}">Administración</a> <span class="divider">/</span></li>
    <li class="active">Usuarios</li>
</ul>
{% endblock %}
{% block content %}
<h2>Usuarios</h2>
<hr/>
{% for message in app.session.flashbag.get('message_error_local2') %}
<div class="alert alert-error">{{ message }}</div>
{% endfor %}
{% if message_error is defined %}<label class="alert alert-error">{{message_error}}</label>{%endif%}
<div class="row-fluid">
    <div class="span6">
        <select id="roles" class="span6">
            {{ render(controller('mycpBundle:BackendUser:get_all_roles', {'selected': '0'})) }}
        </select>&nbsp;
        <a class="btn" style="margin-top: -10px" href="javascript:go_to_form()"><i class="icon-plus"></i> Adicionar usuario</a>
    </div>
    <div class="span6">
        <a class="btn pull-right btn-danger" style="margin-left: 8px" href="javascript:go_to_delete_rol()"><i class="icon-minus icon-white"></i> Rol</a>
        <a class="btn pull-right" style="margin-left: 8px" href="javascript:go_to_new_rol()"><i class="icon-plus"></i> Rol</a>
        <select id="subroles" class="span6 pull-right">
            {{ render(controller('mycpBundle:BackendUser:get_roles_staff')) }}
        </select>
    </div>
</div>
<br/>
{% for message in app.session.flashbag.get('message_error_local') %}
<div class="alert alert-error">{{ message }}</div>
{% endfor %}
<form onkeypress="javascript:submit_filters(event);" id="filter" method="post" action="{{path('mycp_list_users')}}">
    <div class="well well-small">
        <div class="row-fluid">
            <div class="span3">
                <label>Nombre usuario:</label>
                <input id="filter_user_name" value="{{filter_user_name}}" class="input-block-level" name="filter_user_name" type="text"/>
            </div>
            <div class="span3">
                <label>Rol:</label>
                <select class="input-block-level" name="filter_role" id="filter_role"/>
                {{ render(controller('mycpBundle:BackendUser:get_all_roles', {'selected': filter_role})) }}
                </select>
            </div>
            <div class="span3">
                <label>Ciudad:</label>
                <input id="filter_city" value="{{filter_city}}" class="input-block-level" name="filter_city" type="text"/>
            </div>
            <div class="span3">
                <label>País:</label>
                <select class="input-block-level" name="filter_country" id="filter_country"/>
                {{ render(controller('mycpBundle:Public:get_countries', {'selected': filter_country})) }}
                </select>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span3"><label>Nombre</label><input id="filter_name" value="{{filter_name}}" class="input-block-level" name="filter_name" type="text"/></div>
            <div class="span4"><label>Apellido</label><input id="filter_last_name" value="{{filter_last_name}}" class="input-block-level" name="filter_last_name" type="text"/></div>
            <div class="span3"><label>Email</label><input id="filter_email" value="{{filter_email}}" class="input-block-level" name="filter_email" type="text"/></div>
            <div class="span2">
                {% if filter_user_name ==''%}{% set filter_user_name='null'%}{%endif%}
                {% if filter_role ==''%}{% set filter_role='null'%}{%endif%}
                {% if filter_city ==''%}{% set filter_city='null'%}{%endif%}
                {% if filter_country ==''%}{% set filter_country='null'%}{%endif%}
                {% if filter_name ==''%}{% set filter_name='null'%}{%endif%}
                {% if filter_last_name ==''%}{% set filter_last_name='null'%}{%endif%}
                {% if filter_email ==''%}{% set filter_email='null'%}{%endif%}
                <label>&nbsp;</label>
                <div class="row-fluid">
                    <div class="span6">
                        <a rel="tooltip" title="Filtrar listado" href="javascript:action_submit();" class="tooltip_msg btn btn-block btn-success"><i class="icon-filter icon-white"></i></a>
                    </div>
                    <div class="span6">
                        <a rel="tooltip" title="Resetear filtrado " href="{{ path('mycp_list_users') }}" class="tooltip_msg btn btn-block btn-danger"><i class="icon-remove icon-white"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% if users %}
<div class="alert">
    <div class="row-fluid">
        <div class="pull-left">
            Mostrando del {{items_per_page * current_page - items_per_page}} al {% if items_per_page * current_page >  total_items%}{{total_items }}{% else %}{{ items_per_page * current_page }}{% endif %} de {{total_items}} registros
        </div>
        <div class="pull-right">
            Mostrar:
            <a class="{% if items_per_page == 100 %}selected{% endif %}" href="{{ path('mycp_list_users',{'items_per_page':100})}}">100</a>
            <a class="{% if items_per_page == 300 %}selected{% endif %}" href="{{ path('mycp_list_users',{'items_per_page':300})}}">300</a>
            <a class="{% if items_per_page == 500 %}selected{% endif %}" href="{{ path('mycp_list_users',{'items_per_page':500})}}">500</a>
            <input class="hidden" name="items_per_page" value="100">
        </div>
    </div>
</div>
<div class="paginator-cont span11">
    {{ simple_paginator_render('mycp_list_users',null,{
'container_class': 'paginator',
'previousPageText': '«',
'nextPageText': '»',
'currentClass': 'current',
'firstPageText': 'Primera',
'lastPageText': 'Última',
'route_params': {'items_per_page':items_per_page,'filter_user_name':filter_user_name,'filter_role':filter_role,'filter_city':filter_city,'filter_country':filter_country,'filter_name':filter_name,'filter_last_name':filter_last_name,'filter_email':filter_email}
}) }}
</div>
<table class="table table-striped table-hover">
    <thead>
    <tr>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>Usuario</th>
        <th>Rol</th>
        <th>Ciudad</th>
        <th>País</th>
        <th style="text-align: right">Acciones</th>
    </tr>
    </thead>
    <tbody>
    {% for user in users %}
    <tr>
        <td>{{user.getUserUserName}}</td>
        <td>{{user.getUserLastName}}</td>
        <td>{{user.getName}}</td>
        <td>{% if user.getUserSubrole.getRoleName is defined %}{{user.getUserSubrole.getRoleName}}{%else%}{{user.getUserRole}}{%endif%}</td>
        <td>{{user.getUserCity}}</td>
        <td>{% if user.getUserCountry %}{{user.getUserCountry.getCoName}}{% else %}-{% endif %}</td>
        <td style="text-align: right"><a class="btn btn-mini" href="{% if user.getUserRole =='ROLE_CLIENT_STAFF'%}{{ path('mycp_edit_user_staff',{'id_user':user.getUserId})}}{% elseif user.getUserRole =='ROLE_CLIENT_CASA'%}{{ path('mycp_edit_user_casa',{'id_user':user.getUserId})}}{% elseif user.getUserRole =='ROLE_CLIENT_TOURIST'%}{{ path('mycp_edit_user_tourist',{'id_user':user.getUserId})}}{% elseif user.getUserRole =='ROLE_CLIENT_PARTNER'%}{{ path('mycp_edit_user_partner',{'id_user':user.getUserId})}}{% else %}{{ path('mycp_edit_user_staff',{'id_user':user.getUserId})}}{% endif %}">Editar</a>
            {% if not user.isEnabled %}
                <a class="btn btn-mini btn-info" href="{{ path("mycp_change_status_user", {"userId": user.userId}) }}">Activar</a>
            {% endif %}
            <button data='{{ path('mycp_delete_user',{'id_user':user.getUserId}) }}' class="btn btn-mini btn-danger delete">Eliminar</button>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
<div class="paginator-cont span11">
    {{ simple_paginator_render('mycp_list_users',null,{
'container_class': 'paginator',
'previousPageText': '«',
'nextPageText': '»',
'currentClass': 'current',
'firstPageText': 'Primera',
'lastPageText': 'Última',
'route_params': {'items_per_page':items_per_page,'filter_user_name':filter_user_name,'filter_role':filter_role,'filter_city':filter_city,'filter_country':filter_country,'filter_name':filter_name,'filter_last_name':filter_last_name,'filter_email':filter_email}
}) }}
</div>
    {% else %}
    <p> <div class="alert alert-block">No hay Usuarios disponibles.</div></p>
    {% endif %}
{% include 'mycpBundle:utils:confirmation_window.html.twig' with {'message':'¿Confirma que desea eliminar el elemento?','confirmation_action_label':'Eliminar'}%}
{% endblock %}
{% block javascripts %}
    {% javascripts
    '@mycpBundle/Resources/public/js/common_list.js'
    filter='?uglifyjs2'
    %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script type="text/javascript">
        url_new_role="{{ path('mycp_new_role' ,{'id_role':'-1'}) }}";
        url_new_role=url_new_role.replace('/-1','');
        url_delete_role="{{ path('mycp_delete_role' ,{'id_role':'-1'}) }}";
        url_delete_role=url_delete_role.replace('/-1','');
        function go_to_form()
        {
            form=$('#roles').val();
            id_role=$('#roles option:selected').attr('class');
            //alert(id_role);
            if(form.indexOf('ROLE_CLIENT_CASA')===0)
            {
                new_url='{{ path('mycp_new_user_casa',{'id_role':'-1'}) }}';
                new_url=new_url.replace('/-1','');
                $(location).attr('href',new_url+'/'+id_role);
            }
            if(form.indexOf('ROLE_CLIENT_TOURIST')===0)
            {
                new_url='{{ path('mycp_new_user_tourist',{'id_role':'-1'}) }}';
                new_url=new_url.replace('/-1','');
                $(location).attr('href',new_url+'/'+id_role);
            }
            if(form.indexOf('ROLE_CLIENT_PARTNER')===0)
            {
                new_url='{{ path('mycp_new_user_partner',{'id_role':'-1'}) }}';
                new_url=new_url.replace('/-1','');
                $(location).attr('href',new_url+'/'+id_role);
            }
            if(form.indexOf('ROLE_CLIENT_STAFF')===0)
            {
                new_url='{{ path('mycp_new_user_staff',{'id_role':'-1'}) }}';
                new_url=new_url.replace('/-1','');
                $(location).attr('href',new_url+'/'+id_role);
            }
            else
            {
                new_url='{{ path('mycp_new_user_staff',{'id_role':'-1'}) }}';
                new_url=new_url.replace('/-1','');
                $(location).attr('href',new_url+'/'+id_role);
            }

        }

        function go_to_new_rol()
        {
            id_role=$('#subroles option:selected').attr('class');
            if(id_role)
                $(location).attr('href',url_new_role+'/'+id_role);
        }

        function go_to_delete_rol()
        {
            id_role=$('#subroles option:selected').attr('class');
            if(id_role)
                $(location).attr('href',url_delete_role+'/'+id_role);
        }
        function submit_filters(ev)
        {
            if(ev.keyCode==13)
            {
                action_submit();
            }
        }

        function action_submit()
        {
            //items_per_page: 100,filter_user_name:'',filter_role:'',filter_city:'',filter_country:'',filter_name:'',filter_last_name:'',filter_email:''}
            items_per_page={{items_per_page}};

            filter_user_name=$('#filter_user_name').val();
            if(filter_user_name=='')filter_user_name='null';

            filter_role=$('#filter_role').val();
            filter_role=filter_role.toLowerCase();
            if(filter_role=='')filter_role='null';

            filter_city=$('#filter_city').val();
            if(filter_city=='')filter_city='null';

            filter_country=$('#filter_country').val();
            if(filter_country=='')filter_country='null';

            filter_name=$('#filter_name').val();
            if(filter_name=='')filter_name='null';

            filter_last_name=$('#filter_last_name').val();
            if(filter_last_name=='')filter_last_name='null';

            filter_email=$('#filter_email').val();
            if(filter_email=='')filter_email='null';

            url_submit=$('#filter').attr('action');

            url_submit=url_submit+'/'+items_per_page+'/'+filter_user_name+'/'+filter_role+'/'+filter_city+'/'+filter_country+'/'+filter_name+'/'+filter_last_name+'/'+filter_email;
            $('#filter').attr('action',url_submit);
            $('#filter').submit();
        }

    </script>
{% endblock %}
