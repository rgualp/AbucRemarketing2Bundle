<?php

namespace MyCp\PartnerBundle\Repository;

use Doctrine\ORM\EntityRepository;
use MyCp\mycpBundle\Entity\user;

/**
 * paTravelAgencyRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class paTravelAgencyRepository extends EntityRepository {

    /**
     * @param $obj
     * @param $file
     * @param $factory
     * @param $send_creation_mail
     * @param $controller
     * @param $container
     */
    public function createUser($obj, $file, $factory, $send_creation_mail, $controller, $container,$pass){
        $em = $this->getEntityManager();
        $agency = $em->getRepository('PartnerBundle:paTravelAgency')->find($obj->getId());
        $subrole = $em->getRepository('mycpBundle:role')->findOneBy(array('role_name' => 'ROLE_CLIENT_PARTNER'));
        $address = $obj->getAddress();
        $phone = $obj->getPhone();
        $email = $obj->getEmail();

        $user = new user();
        $user2 = new user();
        $encoder = $factory->getEncoder($user2);
        $password = $encoder->encodePassword($pass, $user->getSalt());
        $user->setUserPassword($password);
        $user->setUserAddress($address);
        $user->setUserCountry($obj->getCountry());
        $user->setUserEmail($email);
        $user->setUserPhone($phone);
        $user->setUserName($obj->getEmail());
        $user->setUserRole('ROLE_CLIENT_PARTNER');
        $user->setUserEnabled(false);
        $user->setUserCreatedByMigration(false);
        $user->setUserSubrole($subrole);
        $user->setUserUserName($obj->getEmail());
        $user->setUserLastName($obj->getName());
        $em->persist($user);
        $em->flush();

        if ($send_creation_mail) {
            \MyCp\mycpBundle\Helpers\UserMails::sendCreateUserPartner($controller, $user->getUserEmail(), $user->getName(), $user->getUserUserName() . ' ' . $user->getUserLastName(), $user->getUserId());
        }

        return $user;
    }
}
